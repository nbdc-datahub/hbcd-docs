# Structural & Functional MRI Processing

Structural and functional MRI data is processed via a sequence of BIDS App pipelines that utilize derivatives generated by the prior pipeline in the sequence:

<table class="compact-table-no-vertical-lines" style="width: 100%; border-collapse: collapse; table-layout: fixed;">
<tbody>
<tr>
  <td><b>BIBSNet</b></td>
  <td style="word-wrap: break-word; white-space: normal;">Generates brain segmentations and brain masks.</td>
</tr>
<tr>
  <td><b>Infant fMRIPrep</b></td>
  <td style="word-wrap: break-word; white-space: normal;">Brain segmentations and masks are fed into Infant fMRIPrep, which produces minimal structural and functional MRI processing including visual quality assessment reports, preprocessed derivatives, and confounds to be used for denoising in subsequent processing procedures.</td>
</tr>
<tr>
  <td><b>XCP-D</b></td>
  <td style="word-wrap: break-word; white-space: normal;">Infant fMRIPrep outputs are fed into XCP-D, which performs functional MRI post-processing and noise regression.</td>
</tr>
</tbody>
</table>

## Dual Surface Reconstruction Methods: M-CRIB-S & Infant FreeSurfer
Infant fMRIPrep supports three surface reconstruction methods, each optimized for a specific age range as described in <a href="https://doi.org/10.1101/2025.05.14.654069">Goncalves et al., 2025</a>.


<table class="table-no-vertical-lines">
<thead>
<tr>
  <th>Surface Recon Method</th>
  <th>Hash ID</th>
  <th>Detailed Documentation</th>
</tr>
</thead>
<tbody>
<tr>
  <td>M-CRIB-S</td>
  <td>0f306a2f+0ef9c88a</td>
  <td style="word-wrap: break-word; white-space: normal;"><a href="https://hbcd-cbrain-processing.readthedocs.io/release_2.0_dev2/tools/nibabies_25.2.0-0f306a2f.html">Infant fMRIPrep - 0f306a2f</a></td>
</tr>
<tr>
  <td>Infant FreeSurfer</td>
  <td>2afa9081+0ef9c88a</td>
  <td style="word-wrap: break-word; white-space: normal;"><a href="https://hbcd-cbrain-processing.readthedocs.io/release_2.0_dev2/tools/nibabies_25.2.0-2afa9081.html">Infant fMRIPrep - 2afa9081</a></td>
</tr>
</tbody>
</table>



<table class="compact-table-no-vertical-lines" style="width: 100%; border-collapse: collapse; table-layout: fixed;">
  <thead>
    <tr>
      <th>Surface Reconstruction Method</th>
      <th>Optimal Age Range</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
<tr>
    <td>M-CRIB-S</td>
    <td>≤ 5 months</td>
    <td style="word-wrap: break-word; white-space: normal;">Neonate method based on the Melbourne Children’s Regional Infant Brain atlases (<a href="https://doi.org/10.1038/s41598-020-61326-2">Adamson et al. 2020</a>)</td>
<tr>
<tr>
    <td>Infant FreeSurfer</td>
    <td>≥ 3 months</td>
    <td style="word-wrap: break-word; white-space: normal;">Modified version of FreeSurfer optimized for infants 0–2 years (<a href="https://doi.org/10.1016/j.neuroimage.2020.116946">Zöllei et al. 2020</a>)</td>
<tr>
<tr>
    <td>FreeSurfer</td>
    <td>≥ 10 months</td>
    <td style="word-wrap: break-word; white-space: normal;">Standard FreeSurfer, developed from adult data (<a href="https://doi.org/10.1006/nimg.1998.0395">Dale et al. 1998</a>)</td>
<tr>
</tbody>
</table>

The current HBCD release includes Infant-fMRIPrep and XCP-D derivatives available separately using **M-CRIB-S** and **Infant FreeSurfer** for surface reconstruction. Full processing details are available [here](https://hbcd-cbrain-processing.readthedocs.io/release_2.0_dev2/tool_details.html) on the external HBCD Processing Site.

Unique hashes are used to distinguish the processing methods. The first component of the hash is derived from Infant fMRIPrep, with dual surface reconstruction methods (`0f306a2f` vs `2afa9081`) whereas the second component of the hash (`0ef9c88a`) is derived from XCP-D processing for which the processing parameters do not differ (e.g. see XCP-D processing configurations for [0f306a2f+0ef9c88a](https://hbcd-cbrain-processing.readthedocs.io/release_2.0_dev2/tools/xcp_d-0f306a2f%2B0ef9c88a.html) vs [afa9081+0ef9c88a](https://hbcd-cbrain-processing.readthedocs.io/release_2.0_dev2/tools/xcp_d-2afa9081%2B0ef9c88a.html)). 

## Pipeline Processing Details

<div id="nibabies" class="table-banner" onclick="toggleCollapse(this)">
  <span class="emoji"><i class="fa-solid fa-diagram-project"></i></span>
  <span class="text-with-link">
  <span class="text">Infant fMRIPrep</span>
  <a class="anchor-link" href="#nibabies" title="Copy link">
  <i class="fa-solid fa-link"></i>
  </a>
  </span>
  <span class="arrow">▸</span>
</div>
<div class="table-collapsible-content">
<p>Infant fMRIPrep adapts the fMRIPrep pipeline for infant MRI data, incorporating age-appropriate templates and processing steps optimized for developing brains.</p>
<p><b>B0 Inhomogeneity Correction</b><br>
Fieldmap estimation is performed using paired EPI images to correct for B0 inhomogeneity. The resulting fieldmap is applied to all BOLD runs for distortion correction.</p>
<p><b>Anatomical Preprocessing</b><br>
T1w and/or T2w images are denoised and corrected for intensity inhomogeneity. Surface reconstruction is performed via <b>M-CRIB-S</b> and <b>Infant FreeSurfer</b>. <i>M-CRIB-S</i> is a modified <code>MCRIBReconAll</code> workflow that uses the T2w reference image and the pre-computed anatomical segmentation from BIBSNet. <b>Infant FreeSurfer</b>, an infant-specific version of default FreeSurfer optimized for infants 0-2 years old, runs <code>infant_recon_all</code> using the T1w reference image. For both, images are normalized first to an age-specific MNI Infant template (0-4.5yr), then to the standard MNI152 space via nonlinear registration for compatibility with adult analyses.</p>
<p><b>Functional Preprocessing</b><br>
For each BOLD run, Infant fMRIPrep performs the following steps:</p>
<ul>
<li><strong>Motion correction</strong>: A reference volume is generated, and head motion parameters are estimated prior to filtering.</li>
<li><strong>Distortion correction</strong>: The estimated fieldmap is aligned to the EPI reference and applied to correct distortions.</li>
<li><strong>Coregistration</strong>: The functional reference is aligned to the T2w anatomical image using boundary-based registration for accurate mapping between spaces.</li>
</ul>
<p><b>Confound Estimation</b><br>
Several confound time series are calculated for each run for quality assessment and later noise modeling:</p>
<ul>
<li>Motion metrics: Framewise displacement (FD) and DVARS</li>
<li>Global signals: Mean signal from CSF, white matter, and whole brain</li>
<li>CompCor components: Physiological noise regressors from aCompCor and tCompCor methods</li>
<li>Derived regressors: Temporal derivatives, quadratic terms, and motion outlier flags (for frames exceeding 0.5 mm FD or 1.5 standardized DVARS thresholds)</li>
</ul>
<p><b>Surface and Grayordinate Outputs</b><br>
BOLD data are resampled to both subject-specific (native) and symmetric (fsLR) surface spaces.
A “goodvoxels” mask is applied during volume-to-surface sampling in fsLR space to exclude unstable regions (voxels whose time-series with a locally high coefficient of variation before surface sampling) before surface projection.
Finally, grayordinates files (91k) are generated using the highest-resolution <code>fsaverage</code> as intermediate standardized surface space for use in surface-based analyses compatible with tools such as the Human Connectome Workbench.</p>
</div>

<div id="xcpd" class="table-banner" onclick="toggleCollapse(this)">
  <span class="emoji"><i class="fa-solid fa-diagram-project"></i></span>
  <span class="text-with-link">
  <span class="text">XCP-D</span>
  <a class="anchor-link" href="#xcpd" title="Copy link">
  <i class="fa-solid fa-link"></i>
  </a>
  </span>
  <span class="arrow">▸</span>
</div>
<div class="table-collapsible-content">
<p><strong>XCP-D</strong> is used to post-process the outputs of Infant-fMRIPrep, generating cleaned, denoised, and parcellated datasets ready for analysis.
<strong>Both anatomical and functional data are parcellated using a set of standard atlases - see<a href="../mri/index.md#parc">Parcellations</a> under <em>MRI Derivatives: Quickstart Guide</em>.</strong></p>
<p><b>Anatomical Processing</b><br>
Native-space T2w images are transformed into standard <strong>MNI152NLin6Asym</strong> space at 1 mm³ resolution.
<strong>fsLR-space</strong> morphometric surfaces are copied from the preprocessing derivatives provided by Infant-fMRIPrep to the XCP-D derivatives.
HCP-style midthickness, inflated, and very-inflated surfaces are generated from the white-matter and pial surface meshes and mapped to fsLR space.<br>
These surfaces and associated metrics are included in the XCP-D derivatives for downstream analysis.</p>

<p><b>Functional Processing</b><br>
For each BOLD run, XCP-D performs a series of cleanup and quality-control steps.</p><br>

<p><i>Preprocessing and Denoising</i></p>
<ul>
<li>The first four volumes (dummy scans) are removed.</li>
<li><strong>Motion correction:</strong> Framewise displacement (FD) is calculated per Power et al. (2014); volumes with FD &gt; 0.3 mm are flagged as high-motion outliers.</li>
<li><strong>Nuisance regression:</strong> 36 confound regressors (motion, tissue, and global signals plus derivatives) are regressed out following the 36P strategy.</li>
<li><strong>Despiking and filtering:</strong> Data are despiked, temporally filtered (0.01–0.08 Hz), and smoothed (6 mm FWHM) to retain low-frequency neural signals while reducing noise.</li>
<li><strong>Censoring:</strong> High-motion volumes are interpolated and later censored to minimize motion artifacts.</li>
</ul>

<p><i>Functional Metrics computed from the cleaned time series:</i></p>
<ul>
<li><strong>ALFF (Amplitude of Low-Frequency Fluctuations):</strong> Quantifies spontaneous low-frequency signal amplitude across voxels.</li>
<li><strong>ReHo (Regional Homogeneity):</strong> Measures local synchronization of neural activity within surface and subcortical regions.</li>
</ul>

<p><i>Connectivity Analysis</i><br>
Parcellated time series are extracted for each atlas, described <a href="../mri/index.md#parc">here</a>, and pairwise functional connectivity is calculated as the Pearson correlation between regional time series.
For participants with multiple runs, postprocessed derivatives are concatenated across runs and directions.</p>
</div>







## References
